# Required Env: MODULE_NAME
# Required extra matrix vector name: cmd, kernel, arch

path@template: ./cmd/{{- matrix.cmd -}}
cgo:
  enabled: false
tags:
- netgo
- osusergo
- timetzdata

ldflags@template:
- -s -w
- -X "{{- env.MODULE_NAME -}}/pkg/version.branch={{- env.GIT_BRANCH -}}"
- -X "{{- env.MODULE_NAME -}}/pkg/version.commit={{- env.GIT_COMMIT -}}"
- -X "{{- env.MODULE_NAME -}}/pkg/version.tag={{- env.GIT_TAG -}}"
- -X "{{- env.MODULE_NAME -}}/pkg/version.arch={{- matrix.arch -}}"
- -X "{{- env.MODULE_NAME -}}/pkg/version.workspaceClean={{- env.GIT_WORKTREE_CLEAN -}}"
# TODO
# - -X "{{- env.MODULE_NAME -}}/pkg/version.goCompilerPlatform=$(go version | cut -d\  -f4)"

outputs@template: |-
  {{- $suffix := "" -}}
  {{- if eq matrix.kernel "windows" -}}
    {{- $suffix = ".exe" -}}
  {{- end -}}

  {{- if and (eq matrix.kernel env.HOST_KERNEL) (eq matrix.arch env.HOST_ARCH) }}
  - build/{{- matrix.cmd -}}{{- $suffix -}}
  {{- end }}
  - build/{{- matrix.cmd -}}.{{- matrix.kernel -}}.{{- matrix.arch -}}{{- $suffix -}}

extra_args:
- -buildmode=exe
- -mod=vendor
- -trimpath
