# Usage:
#
#   tools:
#     buildah:
#     - cmd@http|template: https://cdn.jsdelivr.net/gh/arhat-dev/dukkha-presets@master/buildah/cmd-in-ctr.yml
#
# Optional env:
#   - RUN_CTR the docker run compatible command for running container
#   - VOLUME_NAME for caching go modules in container
#   - WORKING_DIR to override DUKKHA_WORKING_DIR
#   - IMAGE to override defualt official buildah image

{{- $run_ctr := strings.Split "," "docker,run" -}}
{{- if env.RUN_CTR -}}
  {{- $run_ctr = fromYaml env.RUN_CTR -}}
{{- else if values.cmd.run_container -}}
  {{- $run_ctr = values.cmd.run_container -}}
{{- end -}}

{{- range $_, $v := $run_ctr }}
- {{ $v }}
{{- end }}

- --entrypoint
- ""
- --workdir
- {{ env.WORKING_DIR | default env.DUKKHA_WORKING_DIR }}
- -v
- {{ env.DUKKHA_WORKING_DIR -}}:{{- env.DUKKHA_WORKING_DIR }}
- -v
- {{ env.VOLUME_NAME | default "buildah" -}}:/var/lib/containers
- --device
- /dev/fuse:rw
- {{ env.IMAGE | default "quay.io/containers/buildah" }}
- buildah
