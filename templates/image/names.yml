{{- define "image.names" -}}

{{- $base_name := var.base_name -}}
{{- $manifest_suffix := var.manifest_suffix | default "" -}}
{{- $kernel := var.kernel
      | default matrix.kernel
      | default host.Kernel
      | default "linux"
-}}

{{- $arch := var.arch
      | default matrix.arch
      | default host.Arch
      | default "amd64"
-}}

{{- $version := var.version
      | default matrix.version
      | default env.VERSION
      | default env.GIT_TAG
      | default ""
      | strings.TrimPrefix "v"
-}}

{{- $can_set_major := true -}}

{{- if not $version -}}
  {{- /*
      no potential semantic version found,

      defaulting to git branch and commit,
      do not set major anyway
  */ -}}

  {{- $can_set_major = false -}}
  {{- $version = env.GIT_BRANCH | strings.KebabCase
      | default (env.GIT_COMMIT | substr 0 8)
      | default "unknown"
  -}}
{{- end -}}

{{- $version_parts := strings.SplitN "." 3 $version -}}
{{- $version_major := index $version_parts 0 -}}

{{- $can_set_major = and $can_set_major (gt (len $version_parts) 1) -}}

{{- $version_minor := "" -}}
{{- if gt (len $version_parts) 1 -}}
  {{- $version_minor = index $version_parts 1 -}}
{{- end -}}

{{- $set_major := false -}}
{{- if $can_set_major -}}
  {{- $set_major = var.set_major | default (ne $version_major "0") -}}
{{- end -}}

{{- $latest := var.latest | default (eq env.GIT_BRANCH env.GIT_DEFAULT_BRANCH) -}}

{{- /* always generate a image name with full version */ -}}
- image: {{ $base_name }}:{{ $version }}-{{ $kernel }}-{{ $arch }}
  manifest: {{ $base_name }}:{{ $version }}{{ $manifest_suffix }}

{{- if $set_major }}
- image: {{ $base_name }}:{{ $version_major }}-{{ $kernel }}-{{ $arch }}
  manifest: {{ $base_name }}:{{ $version_major }}{{ $manifest_suffix }}
{{- end }}

{{- if $version_minor }}
- image: {{ $base_name }}:{{ $version_major }}.{{ $version_minor }}-{{ $kernel }}-{{ $arch }}
  manifest: {{ $base_name }}:{{ $version_major }}.{{ $version_minor }}{{ $manifest_suffix }}
{{- end }}

{{- if $latest }}
- image: {{ $base_name }}:latest-{{ $kernel }}-{{ $arch }}
  manifest: {{ $base_name }}:latest{{ $manifest_suffix }}
{{- end }}

{{- end -}}
